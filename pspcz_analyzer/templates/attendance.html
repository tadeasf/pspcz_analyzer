{% extends "base.html" %}
{% block title %}Attendance — Czech Parliament Analyzer{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Attendance Analysis</h1>
    <p>Who shows up to vote — and how do they vote?</p>
</div>

<details class="methodology">
    <summary>How is attendance calculated?</summary>
    <article>
        <p>For each MP, every recorded vote is categorized as:</p>
        <ul>
            <li><strong>Active</strong> — voted YES (A), NO (B), or ABSTAINED (C)</li>
            <li><strong>Passive</strong> — registered in the chamber but did not press any button (F)</li>
            <li><strong>Absent</strong> — not registered at the time of the vote (@)</li>
            <li><strong>Excused</strong> — formally excused absence (M)</li>
        </ul>
        <p><strong>Attendance %</strong> = Active / (Total - Excused) x 100</p>
        <p>Excused absences are excluded from the denominator because they are legitimate (government duties, illness, etc.).</p>
        <p>The vote breakdown shows how each MP splits their active votes between YES, NO, and ABSTAIN.</p>
    </article>
</details>

<form id="attendance-form" hx-get="/api/attendance" hx-target="#results" hx-indicator="#loading">
    <input type="hidden" name="period" value="{{ period }}">
    <div class="form-row">
        <label>
            Top N MPs
            <input type="number" name="top" value="30" min="5" max="200" step="5">
        </label>
        <label>
            Sort by
            <select name="sort">
                <optgroup label="Attendance">
                    <option value="worst">Lowest attendance first</option>
                    <option value="best">Highest attendance first</option>
                </optgroup>
                <optgroup label="Activity">
                    <option value="most_active">Most active (by volume)</option>
                    <option value="least_active">Least active (by volume)</option>
                </optgroup>
                <optgroup label="Vote breakdown">
                    <option value="most_yes">Most YES votes</option>
                    <option value="most_no">Most NO votes</option>
                    <option value="most_abstained">Most abstentions</option>
                </optgroup>
                <optgroup label="Absence">
                    <option value="most_passive">Most passive (didn't press button)</option>
                    <option value="most_absent">Most absent</option>
                    <option value="most_excused">Most excused</option>
                </optgroup>
            </select>
        </label>
        <label>
            Party filter
            <input type="text" name="party" placeholder="All parties" value="">
        </label>
        <div class="form-submit">
            <label>&nbsp;</label>
            <button type="submit">Analyze</button>
        </div>
    </div>
</form>

<span id="loading" class="htmx-indicator" aria-busy="true">Loading...</span>

<div class="chart-container">
    <img id="attendance-chart" src="/charts/attendance.png?period={{ period }}" alt="Attendance chart" loading="lazy">
</div>

<div id="results" hx-get="/api/attendance?top=30&sort=worst&period={{ period }}" hx-trigger="load" hx-indicator="#loading">
    <div class="skeleton">{% for _ in range(8) %}
    <div class="skeleton-pulse skeleton-table-row"></div>
    {% endfor %}</div>
</div>

<script>
document.getElementById('attendance-form').addEventListener('htmx:beforeRequest', function() {
    var form = this;
    var params = new URLSearchParams(new FormData(form));
    document.getElementById('attendance-chart').src = '/charts/attendance.png?' + params.toString();
});
</script>
{% endblock %}
