{% extends "base.html" %}
{% block title %}Vote Detail — Czech Parliament Analyzer{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Vote #{{ detail.info.id_hlasovani }}</h1>
    <p>{{ detail.info.datum }} {{ detail.info.cas }} — Session {{ detail.info.schuze }}, Vote {{ detail.info.cislo }}</p>
</div>

<article>
    <header>
        <strong>{{ detail.info.outcome_label }}</strong>
    </header>
    {% if detail.info.nazev_dlouhy %}
    <p>{{ detail.info.nazev_dlouhy }}</p>
    {% endif %}
    {% if detail.info.nazev_kratky and detail.info.nazev_kratky != detail.info.nazev_dlouhy %}
    <p><small>{{ detail.info.nazev_kratky }}</small></p>
    {% endif %}

    {% if detail.info.tisk_topics %}
    <p>
        <strong>Topics:</strong>
        {% for t in detail.info.tisk_topics %}
        <span class="topic-badge">{{ t }}</span>
        {% endfor %}
    </p>
    {% endif %}

    {% if detail.info.tisk_summary %}
    <div class="info-box">
        <div class="info-box-header">
            AI Summary
            <small>(generated by local LLM)</small>
        </div>
        <p>{{ detail.info.tisk_summary }}</p>
    </div>
    {% endif %}

    {% if detail.info.tisk_current_stage %}
    <p>
        <strong>This vote:</strong>
        <span class="stage-badge">{{ detail.info.tisk_current_stage.label }}</span>
        {% if detail.info.tisk_current_stage.outcome %}
        <small class="vote-passive"> — {{ detail.info.tisk_current_stage.outcome }}</small>
        {% endif %}
    </p>
    {% endif %}

    {% if detail.info.tisk_history and detail.info.tisk_history.stages %}
    <div class="legis-box">
        <div class="legis-box-header">
            Legislative Process
            {% if detail.info.tisk_submitter %}
            <small>Submitted by: {{ detail.info.tisk_submitter }}</small>
            {% endif %}
            {% if detail.info.tisk_current_status %}
            <span class="status-badge">{{ detail.info.tisk_current_status }}</span>
            {% endif %}
            {% if detail.info.tisk_law_number %}
            <small class="law-number">{{ detail.info.tisk_law_number }}</small>
            {% endif %}
        </div>
        <div class="legislative-timeline">
            {% for stage in detail.info.tisk_history.stages %}
            <div class="timeline-stage {% if detail.info.tisk_current_stage and stage.stage_type == detail.info.tisk_current_stage.stage_type and stage.vote_number == detail.info.tisk_current_stage.vote_number and stage.date == detail.info.tisk_current_stage.date %}timeline-stage-active{% endif %}">
                <div class="timeline-dot"></div>
                <span class="timeline-label">{{ stage.label }}</span>
                {% if stage.date %}
                <span class="timeline-date">{{ stage.date }}</span>
                {% endif %}
                {% if stage.outcome %}
                <div class="timeline-outcome {% if 'schválen' in stage.outcome or 'podepsal' in stage.outcome or 'doporučuje' in stage.outcome %}timeline-approved{% elif 'zamítnut' in stage.outcome or 'nedoporučuje' in stage.outcome %}timeline-rejected{% endif %}">
                    {{ stage.outcome }}
                    {% if stage.vote_number %}
                    <small>(hlasování č. {{ stage.vote_number }})</small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% if detail.info.tisk_url %}
        <p style="margin: 0.5rem 0 0; font-size: 0.85rem;">
            <a href="{{ detail.info.tisk_url }}" target="_blank">Full legislative history on psp.cz &nearr;</a>
        </p>
        {% endif %}
    </div>
    {% endif %}

    <p>
        <a href="https://www.psp.cz/sqw/hlasy.sqw?G={{ detail.info.id_hlasovani }}" target="_blank" class="btn-outline btn-small">View vote on psp.cz &nearr;</a>
        {% if detail.info.tisk_url %}
        <a href="{{ detail.info.tisk_url }}" target="_blank" class="btn-explore btn-small">Document: Tisk {{ detail.info.tisk_ct }} — {{ detail.info.tisk_nazev }} &nearr;</a>
        {% endif %}
    </p>

    {% if detail.info.tisk_ct %}
    <details id="tisk-details">
        <summary>View tisk transcription (extracted PDF text)</summary>
        <div id="tisk-text-content"
             hx-get="/api/tisk-text?period={{ period }}&ct={{ detail.info.tisk_ct }}"
             hx-trigger="intersect once"
             hx-indicator="#tisk-loading">
            <span id="tisk-loading" class="htmx-indicator" aria-busy="true">Loading transcription...</span>
        </div>
    </details>

    <div id="tisk-evolution-content"
         hx-get="/api/tisk-evolution?period={{ period }}&ct={{ detail.info.tisk_ct }}"
         hx-trigger="intersect once"
         hx-indicator="#evolution-loading">
        <span id="evolution-loading" class="htmx-indicator" aria-busy="true">Loading legislative evolution...</span>
    </div>
    {% endif %}

    <div class="stat-grid">
        <article class="stat-card stat-card-green">
            <h3>{{ detail.info.pro }}</h3>
            <p>For</p>
        </article>
        <article class="stat-card stat-card-red">
            <h3>{{ detail.info.proti }}</h3>
            <p>Against</p>
        </article>
        <article class="stat-card stat-card-orange">
            <h3>{{ detail.info.zdrzel }}</h3>
            <p>Abstained</p>
        </article>
        <article class="stat-card stat-card-gray">
            <h3>{{ detail.info.nehlasoval }}</h3>
            <p>Did not vote</p>
        </article>
    </div>
</article>

<h2>Party Breakdown</h2>
<div class="overflow-auto">
    <table>
        <thead>
            <tr>
                <th>Party</th>
                <th>YES</th>
                <th>NO</th>
                <th>Abstained</th>
                <th>Passive</th>
                <th>Absent</th>
                <th>Excused</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for row in detail.party_breakdown %}
            <tr>
                <td><strong>{{ row.party or "?" }}</strong></td>
                <td class="vote-yes">{{ row.yes }}</td>
                <td class="vote-no">{{ row.no }}</td>
                <td class="vote-abstained">{{ row.abstained }}</td>
                <td>{{ row.passive }}</td>
                <td>{{ row.absent }}</td>
                <td>{{ row.excused }}</td>
                <td>{{ row.total }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>Individual MPs</h2>

<details>
    <summary>Show all {{ detail.mp_votes | length }} MP votes</summary>
    <div class="overflow-auto">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>MP</th>
                    <th>Party</th>
                    <th>Vote</th>
                </tr>
            </thead>
            <tbody>
                {% for mp in detail.mp_votes %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ mp.jmeno }} {{ mp.prijmeni }}</td>
                    <td>{{ mp.party or "?" }}</td>
                    <td>
                        {% if mp.vote_label == "YES" %}
                        <span class="vote-yes">{{ mp.vote_label }}</span>
                        {% elif mp.vote_label == "NO" %}
                        <span class="vote-no">{{ mp.vote_label }}</span>
                        {% elif mp.vote_label == "ABSTAINED" %}
                        <span class="vote-abstained">{{ mp.vote_label }}</span>
                        {% else %}
                        <span class="vote-passive">{{ mp.vote_label }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</details>

<p><a href="/votes?period={{ period }}">&larr; Back to Votes Browser</a></p>
{% endblock %}
