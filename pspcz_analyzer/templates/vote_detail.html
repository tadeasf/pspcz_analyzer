{% extends "base.html" %}
{% block title %}{{ _("detail.vote_id").format(id=detail.info.id_hlasovani) }} — {{ _("site.short_title") }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _("detail.vote_id").format(id=detail.info.id_hlasovani) }}</h1>
    <p>{{ detail.info.datum }} {{ detail.info.cas }} — {{ _("detail.session_vote").format(session=detail.info.schuze, number=detail.info.cislo) }}</p>
</div>

<article>
    <header>
        <strong>{{ detail.info.outcome_label }}</strong>
    </header>
    {% if detail.info.nazev_dlouhy %}
    <p>{{ detail.info.nazev_dlouhy }}</p>
    {% endif %}
    {% if detail.info.nazev_kratky and detail.info.nazev_kratky != detail.info.nazev_dlouhy %}
    <p><small>{{ detail.info.nazev_kratky }}</small></p>
    {% endif %}

    {% if detail.info.tisk_topics %}
    <p>
        <strong>{{ _("detail.topics") }}</strong>
        {% for t in detail.info.tisk_topics %}
        <span class="topic-badge">{{ t }}</span>
        {% endfor %}
    </p>
    {% endif %}

    {% set show_summary = detail.info.tisk_summary_en if (lang == "en" and detail.info.tisk_summary_en) else detail.info.tisk_summary %}
    {% if show_summary %}
    <div class="info-box">
        <div class="info-box-header">
            {{ _("detail.ai_summary") }}
            <small>{{ _("detail.ai_generated") }}</small>
        </div>
        {{ show_summary | markdown }}
    </div>
    {% endif %}

    {% if detail.info.tisk_current_stage %}
    <p>
        <strong>{{ _("detail.this_vote") }}</strong>
        <span class="stage-badge">{{ detail.info.tisk_current_stage.label }}</span>
        {% if detail.info.tisk_current_stage.outcome %}
        <small class="vote-passive"> — {{ detail.info.tisk_current_stage.outcome }}</small>
        {% endif %}
    </p>
    {% endif %}

    {% if detail.info.tisk_history and detail.info.tisk_history.stages %}
    <div class="legis-box">
        <div class="legis-box-header">
            {{ _("detail.legislative_process") }}
            {% if detail.info.tisk_submitter %}
            <small>{{ _("detail.submitted_by") }} {{ detail.info.tisk_submitter }}</small>
            {% endif %}
            {% if detail.info.tisk_current_status %}
            <span class="status-badge">{{ detail.info.tisk_current_status }}</span>
            {% endif %}
            {% if detail.info.tisk_law_number %}
            <small class="law-number">{{ detail.info.tisk_law_number }}</small>
            {% endif %}
        </div>
        <div class="legislative-timeline">
            {% for stage in detail.info.tisk_history.stages %}
            <div class="timeline-stage {% if detail.info.tisk_current_stage and stage.stage_type == detail.info.tisk_current_stage.stage_type and stage.vote_number == detail.info.tisk_current_stage.vote_number and stage.date == detail.info.tisk_current_stage.date %}timeline-stage-active{% endif %}">
                <div class="timeline-dot"></div>
                <span class="timeline-label">{{ stage.label }}</span>
                {% if stage.date %}
                <span class="timeline-date">{{ stage.date }}</span>
                {% endif %}
                {% if stage.outcome %}
                <div class="timeline-outcome {% if 'schválen' in stage.outcome or 'podepsal' in stage.outcome or 'doporučuje' in stage.outcome %}timeline-approved{% elif 'zamítnut' in stage.outcome or 'nedoporučuje' in stage.outcome %}timeline-rejected{% endif %}">
                    {{ stage.outcome }}
                    {% if stage.vote_number %}
                    <small>(hlasování č. {{ stage.vote_number }})</small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% if detail.info.tisk_url %}
        <p style="margin: 0.5rem 0 0; font-size: 0.85rem;">
            <a href="{{ detail.info.tisk_url }}" target="_blank">{{ _("detail.full_history") }} &nearr;</a>
        </p>
        {% endif %}
    </div>
    {% endif %}

    <p>
        <a href="https://www.psp.cz/sqw/hlasy.sqw?G={{ detail.info.id_hlasovani }}" target="_blank" class="btn-outline btn-small">{{ _("detail.view_on_psp") }} &nearr;</a>
        {% if detail.info.tisk_url %}
        <a href="{{ detail.info.tisk_url }}" target="_blank" class="btn-explore btn-small">{{ _("detail.document").format(ct=detail.info.tisk_ct, name=detail.info.tisk_nazev) }} &nearr;</a>
        {% endif %}
    </p>

    {% if detail.info.tisk_ct %}
    <details id="tisk-details">
        <summary>{{ _("detail.view_tisk") }}</summary>
        <div id="tisk-text-content"
             hx-get="/api/tisk-text?period={{ period }}&ct={{ detail.info.tisk_ct }}"
             hx-trigger="intersect once"
             hx-indicator="#tisk-loading">
            <span id="tisk-loading" class="htmx-indicator" aria-busy="true">{{ _("detail.loading_tisk") }}</span>
        </div>
    </details>

    <div id="tisk-evolution-content"
         hx-get="/api/tisk-evolution?period={{ period }}&ct={{ detail.info.tisk_ct }}"
         hx-trigger="intersect once"
         hx-indicator="#evolution-loading">
        <span id="evolution-loading" class="htmx-indicator" aria-busy="true">{{ _("detail.loading_evolution") }}</span>
    </div>
    {% endif %}

    <div class="stat-grid">
        <article class="stat-card stat-card-green">
            <h3>{{ detail.info.pro }}</h3>
            <p>{{ _("detail.for") }}</p>
        </article>
        <article class="stat-card stat-card-red">
            <h3>{{ detail.info.proti }}</h3>
            <p>{{ _("detail.against") }}</p>
        </article>
        <article class="stat-card stat-card-orange">
            <h3>{{ detail.info.zdrzel }}</h3>
            <p>{{ _("detail.abstained") }}</p>
        </article>
        <article class="stat-card stat-card-gray">
            <h3>{{ detail.info.nehlasoval }}</h3>
            <p>{{ _("detail.did_not_vote") }}</p>
        </article>
    </div>
</article>

<h2>{{ _("detail.party_breakdown") }}</h2>
<div class="overflow-auto">
    <table>
        <thead>
            <tr>
                <th>{{ _("th.party") }}</th>
                <th>{{ _("th.yes") }}</th>
                <th>{{ _("th.no") }}</th>
                <th>{{ _("th.abstained") }}</th>
                <th>{{ _("th.passive") }}</th>
                <th>{{ _("th.absent") }}</th>
                <th>{{ _("th.excused") }}</th>
                <th>{{ _("th.total") }}</th>
            </tr>
        </thead>
        <tbody>
            {% for row in detail.party_breakdown %}
            <tr>
                <td><strong>{{ row.party or "?" }}</strong></td>
                <td class="vote-yes">{{ row.yes }}</td>
                <td class="vote-no">{{ row.no }}</td>
                <td class="vote-abstained">{{ row.abstained }}</td>
                <td>{{ row.passive }}</td>
                <td>{{ row.absent }}</td>
                <td>{{ row.excused }}</td>
                <td>{{ row.total }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>{{ _("detail.individual_mps") }}</h2>

<details>
    <summary>{{ _("detail.show_all_votes").format(count=detail.mp_votes | length) }}</summary>
    <div class="overflow-auto">
        <table>
            <thead>
                <tr>
                    <th>{{ _("th.rank") }}</th>
                    <th>{{ _("th.mp") }}</th>
                    <th>{{ _("th.party") }}</th>
                    <th>{{ _("th.vote") }}</th>
                </tr>
            </thead>
            <tbody>
                {% for mp in detail.mp_votes %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ mp.jmeno }} {{ mp.prijmeni }}</td>
                    <td>{{ mp.party or "?" }}</td>
                    <td>
                        {% if mp.vote_label == "YES" %}
                        <span class="vote-yes">{{ _("vote.yes") }}</span>
                        {% elif mp.vote_label == "NO" %}
                        <span class="vote-no">{{ _("vote.no") }}</span>
                        {% elif mp.vote_label == "ABSTAINED" %}
                        <span class="vote-abstained">{{ _("vote.abstained") }}</span>
                        {% elif mp.vote_label == "Absent" %}
                        <span class="vote-passive">{{ _("vote.absent") }}</span>
                        {% elif mp.vote_label == "Excused" %}
                        <span class="vote-passive">{{ _("vote.excused") }}</span>
                        {% else %}
                        <span class="vote-passive">{{ _("vote.passive") }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</details>

<p><a href="/votes?period={{ period }}">&larr; {{ _("detail.back_to_votes") }}</a></p>
{% endblock %}
