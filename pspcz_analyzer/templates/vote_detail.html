{% extends "base.html" %}
{% block title %}Vote Detail — Czech Parliament Analyzer{% endblock %}

{% block content %}
<hgroup>
    <h1>Vote #{{ detail.info.id_hlasovani }}</h1>
    <p>{{ detail.info.datum }} {{ detail.info.cas }} — Session {{ detail.info.schuze }}, Vote {{ detail.info.cislo }}</p>
</hgroup>

<article>
    <header>
        <strong>{{ detail.info.outcome_label }}</strong>
    </header>
    {% if detail.info.nazev_dlouhy %}
    <p>{{ detail.info.nazev_dlouhy }}</p>
    {% endif %}
    {% if detail.info.nazev_kratky and detail.info.nazev_kratky != detail.info.nazev_dlouhy %}
    <p><small>{{ detail.info.nazev_kratky }}</small></p>
    {% endif %}

    {% if detail.info.tisk_topics %}
    <p>
        <strong>Topics:</strong>
        {% for t in detail.info.tisk_topics %}
        <span style="background: #e3f2fd; color: #1565c0; padding: 0.15rem 0.5rem; border-radius: 0.25rem; margin-right: 0.25rem; font-size: 0.85rem;">{{ t }}</span>
        {% endfor %}
    </p>
    {% endif %}

    {% if detail.info.tisk_summary %}
    <article style="background: #1a2332; border: 1px solid #2a3a4e; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
        <header style="margin-bottom: 0.5rem;">
            <strong style="color: #e0e6ed;">AI Summary</strong>
            <small style="color: #7a8a9e; margin-left: 0.5rem;">(generated by local LLM)</small>
        </header>
        <p style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9rem; color: #c8d2dc;">{{ detail.info.tisk_summary }}</p>
    </article>
    {% endif %}

    {% if detail.info.tisk_current_stage %}
    <p>
        <strong>This vote:</strong>
        <span style="background:#1565c0;color:#e3f2fd;padding:0.2rem 0.6rem;border-radius:0.25rem;font-size:0.85rem;">
            {{ detail.info.tisk_current_stage.label }}
        </span>
        {% if detail.info.tisk_current_stage.outcome %}
        <span style="margin-left:0.4rem;font-size:0.85rem;color:#9aa6b4;">— {{ detail.info.tisk_current_stage.outcome }}</span>
        {% endif %}
    </p>
    {% endif %}

    {% if detail.info.tisk_history and detail.info.tisk_history.stages %}
    <article style="background: #1a2332; border: 1px solid #2a3a4e; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
        <header style="margin-bottom: 0.5rem;">
            <strong style="color: #e0e6ed;">Legislative Process</strong>
            {% if detail.info.tisk_submitter %}
            <small style="color: #7a8a9e; margin-left: 0.5rem;">Submitted by: {{ detail.info.tisk_submitter }}</small>
            {% endif %}
            {% if detail.info.tisk_current_status %}
            <span style="float:right;background:#2a3a4e;color:#c8d2dc;padding:0.15rem 0.5rem;border-radius:0.25rem;font-size:0.8rem;">{{ detail.info.tisk_current_status }}</span>
            {% endif %}
            {% if detail.info.tisk_law_number %}
            <small style="color: #66bb6a; margin-left: 0.5rem;">{{ detail.info.tisk_law_number }}</small>
            {% endif %}
        </header>
        <div class="legislative-timeline">
            {% for stage in detail.info.tisk_history.stages %}
            <div class="timeline-stage {% if detail.info.tisk_current_stage and stage.stage_type == detail.info.tisk_current_stage.stage_type and stage.vote_number == detail.info.tisk_current_stage.vote_number and stage.date == detail.info.tisk_current_stage.date %}timeline-stage-active{% endif %}">
                <div class="timeline-dot"></div>
                <span class="timeline-label">{{ stage.label }}</span>
                {% if stage.date %}
                <span class="timeline-date">{{ stage.date }}</span>
                {% endif %}
                {% if stage.outcome %}
                <div class="timeline-outcome {% if 'schválen' in stage.outcome or 'podepsal' in stage.outcome or 'doporučuje' in stage.outcome %}timeline-approved{% elif 'zamítnut' in stage.outcome or 'nedoporučuje' in stage.outcome %}timeline-rejected{% endif %}">
                    {{ stage.outcome }}
                    {% if stage.vote_number %}
                    <small>(hlasování č. {{ stage.vote_number }})</small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% if detail.info.tisk_url %}
        <p style="margin: 0.5rem 0 0; font-size: 0.85rem;">
            <a href="{{ detail.info.tisk_url }}" target="_blank" style="color: #42a5f5;">Full legislative history on psp.cz &nearr;</a>
        </p>
        {% endif %}
    </article>
    {% endif %}

    <p>
        <a href="https://www.psp.cz/sqw/hlasy.sqw?G={{ detail.info.id_hlasovani }}" target="_blank" role="button" class="outline" style="font-size: 0.85rem;">View vote on psp.cz &nearr;</a>
        {% if detail.info.tisk_url %}
        <a href="{{ detail.info.tisk_url }}" target="_blank" role="button" style="font-size: 0.85rem;">Document: Tisk {{ detail.info.tisk_ct }} — {{ detail.info.tisk_nazev }} &nearr;</a>
        {% endif %}
    </p>

    {% if detail.info.tisk_ct %}
    <details id="tisk-details">
        <summary>View tisk transcription (extracted PDF text)</summary>
        <div id="tisk-text-content"
             hx-get="/api/tisk-text?period={{ period }}&ct={{ detail.info.tisk_ct }}"
             hx-trigger="intersect once"
             hx-indicator="#tisk-loading">
            <span id="tisk-loading" class="htmx-indicator" aria-busy="true">Loading transcription...</span>
        </div>
    </details>
    {% endif %}

    <div class="stat-grid">
        <article class="stat-card" style="border-left: 4px solid #4caf50;">
            <h3>{{ detail.info.pro }}</h3>
            <p>For</p>
        </article>
        <article class="stat-card" style="border-left: 4px solid #f44336;">
            <h3>{{ detail.info.proti }}</h3>
            <p>Against</p>
        </article>
        <article class="stat-card" style="border-left: 4px solid #ff9800;">
            <h3>{{ detail.info.zdrzel }}</h3>
            <p>Abstained</p>
        </article>
        <article class="stat-card" style="border-left: 4px solid #9e9e9e;">
            <h3>{{ detail.info.nehlasoval }}</h3>
            <p>Did not vote</p>
        </article>
    </div>
</article>

<h2>Party Breakdown</h2>
<div class="overflow-auto">
    <table>
        <thead>
            <tr>
                <th>Party</th>
                <th>YES</th>
                <th>NO</th>
                <th>Abstained</th>
                <th>Passive</th>
                <th>Absent</th>
                <th>Excused</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for row in detail.party_breakdown %}
            <tr>
                <td><strong>{{ row.party or "?" }}</strong></td>
                <td style="color: #4caf50;">{{ row.yes }}</td>
                <td style="color: #f44336;">{{ row.no }}</td>
                <td style="color: #ff9800;">{{ row.abstained }}</td>
                <td>{{ row.passive }}</td>
                <td>{{ row.absent }}</td>
                <td>{{ row.excused }}</td>
                <td>{{ row.total }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>Individual MPs</h2>

<details>
    <summary>Show all {{ detail.mp_votes | length }} MP votes</summary>
    <div class="overflow-auto">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>MP</th>
                    <th>Party</th>
                    <th>Vote</th>
                </tr>
            </thead>
            <tbody>
                {% for mp in detail.mp_votes %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ mp.jmeno }} {{ mp.prijmeni }}</td>
                    <td>{{ mp.party or "?" }}</td>
                    <td>
                        {% if mp.vote_label == "YES" %}
                        <span style="color: #4caf50;">{{ mp.vote_label }}</span>
                        {% elif mp.vote_label == "NO" %}
                        <span style="color: #f44336;">{{ mp.vote_label }}</span>
                        {% elif mp.vote_label == "ABSTAINED" %}
                        <span style="color: #ff9800;">{{ mp.vote_label }}</span>
                        {% else %}
                        <span style="color: #9e9e9e;">{{ mp.vote_label }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</details>

<p><a href="/votes?period={{ period }}">&larr; Back to Votes Browser</a></p>
{% endblock %}
